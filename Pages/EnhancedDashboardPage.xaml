<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Cashere.Pages.EnhancedDashboardPage"
              xmlns:charts="clr-namespace:Microcharts.Maui;assembly=Microcharts.Maui"
             BackgroundColor="#F5F5F5">

    <Grid RowDefinitions="60,*" Padding="0">

        <!-- Header -->
        <Grid Grid.Row="0" BackgroundColor="#2C3E50" Padding="20,10">
            <Grid ColumnDefinitions="*,Auto,Auto">
                <Label Grid.Column="0" Text="📊 Finance Dashboard" FontSize="24" 
                       FontAttributes="Bold" TextColor="White" VerticalOptions="Center"/>
                <Button Grid.Column="1" Text="🔄 Refresh" 
                        BackgroundColor="#3498DB" TextColor="White" Margin="0,0,10,0"
                        Command="{Binding RefreshCommand}"/>
                <Button Grid.Column="2" Text="← Back" 
                        BackgroundColor="#95A5A6" TextColor="White" 
                        Command="{Binding BackCommand}"/>
            </Grid>
        </Grid>

        <!-- Content -->
        <ScrollView Grid.Row="1" Padding="20">
            <StackLayout Spacing="20">

                <!-- Date Selector -->
                <Frame BackgroundColor="White" Padding="15" CornerRadius="10" HasShadow="True">
                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                        <Label Grid.Column="0" Text="Select Period" FontSize="14" 
                               FontAttributes="Bold" VerticalOptions="Center"/>
                        <Button Grid.Column="1" Text="Today" 
                                BackgroundColor="{Binding IsTodaySelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#3498DB|#95A5A6'}"
                                TextColor="White" WidthRequest="80"
                                Command="{Binding SelectPeriodCommand}" CommandParameter="Today"/>
                        <Button Grid.Column="2" Text="This Week" 
                                BackgroundColor="{Binding IsWeekSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#3498DB|#95A5A6'}"
                                TextColor="White" WidthRequest="100"
                                Command="{Binding SelectPeriodCommand}" CommandParameter="Week"/>
                    </Grid>
                </Frame>

                <!-- Summary Cards -->
                <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="10">
                    <!-- Total Revenue -->
                    <Frame Grid.Column="0" BackgroundColor="White" Padding="15" 
                           CornerRadius="10" HasShadow="True">
                        <StackLayout Spacing="5">
                            <Label Text="💰" FontSize="24" HorizontalOptions="Center"/>
                            <Label Text="Total Revenue" FontSize="11" 
                                   TextColor="#666" HorizontalTextAlignment="Center"/>
                            <Label Text="{Binding TotalRevenue, StringFormat='Rp {0:N0}'}" 
                                   FontSize="18" FontAttributes="Bold" 
                                   TextColor="#27AE60" HorizontalTextAlignment="Center"/>
                            <Label Text="{Binding TotalTransactions, StringFormat='{0} orders'}" 
                                   FontSize="10" TextColor="#999" HorizontalTextAlignment="Center"/>
                        </StackLayout>
                    </Frame>

                    <!-- Cash -->
                    <Frame Grid.Column="1" BackgroundColor="White" Padding="15" 
                           CornerRadius="10" HasShadow="True">
                        <StackLayout Spacing="5">
                            <Label Text="💵" FontSize="24" HorizontalOptions="Center"/>
                            <Label Text="Cash" FontSize="11" 
                                   TextColor="#666" HorizontalTextAlignment="Center"/>
                            <Label Text="{Binding TotalCash, StringFormat='Rp {0:N0}'}" 
                                   FontSize="18" FontAttributes="Bold" 
                                   TextColor="#3498DB" HorizontalTextAlignment="Center"/>
                            <Label Text="{Binding CashPercentage, StringFormat='{0:F1}%'}" 
                                   FontSize="10" TextColor="#999" HorizontalTextAlignment="Center"/>
                        </StackLayout>
                    </Frame>

                    <!-- QRIS -->
                    <Frame Grid.Column="2" BackgroundColor="White" Padding="15" 
                           CornerRadius="10" HasShadow="True">
                        <StackLayout Spacing="5">
                            <Label Text="📱" FontSize="24" HorizontalOptions="Center"/>
                            <Label Text="QRIS" FontSize="11" 
                                   TextColor="#666" HorizontalTextAlignment="Center"/>
                            <Label Text="{Binding TotalQRIS, StringFormat='Rp {0:N0}'}" 
                                   FontSize="18" FontAttributes="Bold" 
                                   TextColor="#9B59B6" HorizontalTextAlignment="Center"/>
                            <Label Text="{Binding QRISPercentage, StringFormat='{0:F1}%'}" 
                                   FontSize="10" TextColor="#999" HorizontalTextAlignment="Center"/>
                        </StackLayout>
                    </Frame>

                    <!-- Tax Collected -->
                    <Frame Grid.Column="3" BackgroundColor="White" Padding="15" 
                           CornerRadius="10" HasShadow="True">
                        <StackLayout Spacing="5">
                            <Label Text="🧾" FontSize="24" HorizontalOptions="Center"/>
                            <Label Text="Tax Collected" FontSize="11" 
                                   TextColor="#666" HorizontalTextAlignment="Center"/>
                            <Label Text="{Binding TotalTax, StringFormat='Rp {0:N0}'}" 
                                   FontSize="18" FontAttributes="Bold" 
                                   TextColor="#E67E22" HorizontalTextAlignment="Center"/>
                            <Label Text="{Binding ItemsSold, StringFormat='{0} items'}" 
                                   FontSize="10" TextColor="#999" HorizontalTextAlignment="Center"/>
                        </StackLayout>
                    </Frame>
                </Grid>

                <!-- Charts Row -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                    <!-- Payment Method Pie Chart -->
                    <Frame Grid.Column="0" BackgroundColor="White" Padding="20" 
                           CornerRadius="10" HasShadow="True">
                        <StackLayout Spacing="15">
                            <Label Text="Payment Methods Breakdown" FontSize="16" 
                                   FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                            <charts:ChartView Chart="{Binding PaymentMethodChart}" 
                                            HeightRequest="250"/>
                            <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto" 
                                  ColumnSpacing="10" RowSpacing="5">
                                <BoxView Grid.Row="0" Grid.Column="0" 
                                        BackgroundColor="#3498DB" WidthRequest="20" HeightRequest="20"/>
                                <Label Grid.Row="0" Grid.Column="1" Text="Cash" 
                                       FontSize="12" VerticalOptions="Center"/>
                                <Label Grid.Row="0" Grid.Column="2" 
                                       Text="{Binding TotalCash, StringFormat='Rp {0:N0}'}" 
                                       FontSize="12" FontAttributes="Bold"/>

                                <BoxView Grid.Row="1" Grid.Column="0" 
                                        BackgroundColor="#9B59B6" WidthRequest="20" HeightRequest="20"/>
                                <Label Grid.Row="1" Grid.Column="1" Text="QRIS" 
                                       FontSize="12" VerticalOptions="Center"/>
                                <Label Grid.Row="1" Grid.Column="2" 
                                       Text="{Binding TotalQRIS, StringFormat='Rp {0:N0}'}" 
                                       FontSize="12" FontAttributes="Bold"/>
                            </Grid>
                        </StackLayout>
                    </Frame>

                    <!-- Sales Trend Line Chart -->
                    <Frame Grid.Column="1" BackgroundColor="White" Padding="20" 
                           CornerRadius="10" HasShadow="True">
                        <StackLayout Spacing="15">
                            <Label Text="Sales Trend (Last 7 Days)" FontSize="16" 
                                   FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                            <charts:ChartView Chart="{Binding SalesTrendChart}" 
                                            HeightRequest="250"/>
                        </StackLayout>
                    </Frame>
                </Grid>

                <!-- Top Selling Items -->
                <Frame BackgroundColor="White" Padding="20" CornerRadius="10" HasShadow="True">
                    <StackLayout Spacing="15">
                        <Label Text="🏆 Top Selling Items" FontSize="16" FontAttributes="Bold"/>

                        <CollectionView ItemsSource="{Binding TopSellingItems}" HeightRequest="200">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto,*,Auto,Auto" Padding="5" ColumnSpacing="10">
                                        <Label Grid.Column="0" 
                                               Text="{Binding Rank, StringFormat='#{0}'}" 
                                               FontSize="14" FontAttributes="Bold" 
                                               TextColor="#3498DB" VerticalOptions="Center"/>
                                        <StackLayout Grid.Column="1" VerticalOptions="Center">
                                            <Label Text="{Binding ItemName}" FontSize="13" FontAttributes="Bold"/>
                                            <Label Text="{Binding Category}" FontSize="10" TextColor="#666"/>
                                        </StackLayout>
                                        <Label Grid.Column="2" 
                                               Text="{Binding QuantitySold, StringFormat='{0} sold'}" 
                                               FontSize="11" TextColor="#27AE60" VerticalOptions="Center"/>
                                        <Label Grid.Column="3" 
                                               Text="{Binding Revenue, StringFormat='Rp {0:N0}'}" 
                                               FontSize="12" FontAttributes="Bold" VerticalOptions="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>
                </Frame>

                <!-- Hourly Sales Distribution -->
                <Frame BackgroundColor="White" Padding="20" CornerRadius="10" HasShadow="True">
                    <StackLayout Spacing="15">
                        <Label Text="⏰ Hourly Sales Distribution" FontSize="16" FontAttributes="Bold"/>
                        <charts:ChartView Chart="{Binding HourlySalesChart}" 
                                        HeightRequest="200"/>
                    </StackLayout>
                </Frame>

                <!-- Recent Transactions -->
                <Frame BackgroundColor="White" Padding="20" CornerRadius="10" HasShadow="True">
                    <StackLayout Spacing="15">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0" Text="📝 Recent Transactions" 
                                   FontSize="16" FontAttributes="Bold"/>
                            <Label Grid.Column="1" Text="View All" 
                                   FontSize="12" TextColor="#3498DB" 
                                   TextDecorations="Underline" VerticalOptions="Center">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ViewAllTransactionsCommand}"/>
                                </Label.GestureRecognizers>
                            </Label>
                        </Grid>

                        <CollectionView ItemsSource="{Binding RecentTransactions}" HeightRequest="300">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame Margin="0,5" Padding="10" BackgroundColor="#F9F9F9" 
                                           CornerRadius="5" HasShadow="False">
                                        <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="10">
                                            <Frame Grid.Column="0" Padding="5" CornerRadius="5" 
                                                   BackgroundColor="{Binding PaymentMethod, Converter={StaticResource PaymentMethodToColorConverter}}"
                                                   HasShadow="False" WidthRequest="50" HeightRequest="50">
                                                <Label Text="{Binding PaymentMethod, Converter={StaticResource PaymentMethodToIconConverter}}" 
                                                       FontSize="20" TextColor="White" 
                                                       HorizontalOptions="Center" VerticalOptions="Center"/>
                                            </Frame>

                                            <StackLayout Grid.Column="1" VerticalOptions="Center">
                                                <Label Text="{Binding OrderNumber}" 
                                                       FontSize="12" FontAttributes="Bold"/>
                                                <Label Text="{Binding TransactionDate, StringFormat='{0:dd/MM/yyyy HH:mm}'}" 
                                                       FontSize="10" TextColor="#666"/>
                                                <Label Text="{Binding ItemCount, StringFormat='{0} items'}" 
                                                       FontSize="10" TextColor="#999"/>
                                            </StackLayout>

                                            <StackLayout Grid.Column="2" VerticalOptions="Center" HorizontalOptions="End">
                                                <Label Text="{Binding OrderTotal, StringFormat='Rp {0:N0}'}" 
                                                       FontSize="13" FontAttributes="Bold"/>
                                                <Label Text="{Binding TaxAmount, StringFormat='Tax: Rp {0:N0}'}" 
                                                       FontSize="10" TextColor="#E67E22"/>
                                            </StackLayout>

                                            <Frame Grid.Column="3" Padding="5,2" CornerRadius="3" 
                                                   BackgroundColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                                   HasShadow="False" VerticalOptions="Center">
                                                <Label Text="{Binding Status}" FontSize="10" 
                                                       TextColor="White" FontAttributes="Bold"/>
                                            </Frame>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>
                </Frame>

                <!-- Export Options -->
                <Frame BackgroundColor="White" Padding="15" CornerRadius="10" HasShadow="True">
                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                        <Label Grid.Column="0" Text="📥 Export Reports" 
                               FontSize="14" FontAttributes="Bold" VerticalOptions="Center"/>
                        <Button Grid.Column="1" Text="📊 Export to Excel" 
                                BackgroundColor="#27AE60" TextColor="White"
                                Command="{Binding ExportToExcelCommand}"/>
                        <Button Grid.Column="2" Text="📄 Print Report" 
                                BackgroundColor="#3498DB" TextColor="White"
                                Command="{Binding PrintReportCommand}"/>
                    </Grid>
                </Frame>

            </StackLayout>
        </ScrollView>
    </Grid>
</ContentPage>